<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CueCode | 로그인</title>
    <link rel="shortcut icon" type="image/png" href="../images/logos/favicon.svg" />
    <!-- 부트스트랩 CSS -->
    <link rel="stylesheet" href="../css/bootstrap.css" />
    <link rel="stylesheet" href="../libs/owl.carousel/dist/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="../libs/aos-master/dist/aos.css">
    <link rel="stylesheet" href="../css/styles.css" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <!-- JWT 디코딩을 위한 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <!-- 사용자 정의 CSS -->
    <link rel="stylesheet" href="../css/user/sign-in.css">
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="login-container">
                <div class="row g-0">
                    <!-- 좌측 Hero 섹션 -->
                    <div class="col-md-6 hero-section d-flex flex-column justify-content-center p-5">
                        <img src="/images/logos/logo-white-clean.svg" alt="CueCode Logo" class="img-fluid mb-4" style="max-width:350px;">
                        <h3 class="mb-3 display-6 fw-bold">Subtle Gestures, Deep Connections</h3>
                        <p class="fs-5">CueCode와 함께라면<br>당신의 표현이 언제나 닿을 수 있어요.</p>
                    </div>
                    <!-- 우측 로그인 폼 -->
                    <div class="col-md-6 d-flex flex-column justify-content-center p-5">
                        <div class="w-100">
                            <h1 class="text-center display-6 fw-bold mb-5">로그인</h1>
                            <form id="loginForm">
                                <div class="mb-4">
                                    <label for="userId" class="form-label">아이디</label>
                                    <input type="text" class="form-control form-control-lg" id="userId" name="userId"
                                           placeholder="아이디를 입력하세요" autocomplete="username" required />
                                </div>
                                <div class="mb-4">
                                    <label for="password" class="form-label">비밀번호</label>
                                    <input type="password" class="form-control form-control-lg" id="password"
                                           name="password" placeholder="비밀번호를 입력하세요" autocomplete="current-password" required />
                                    <div class="form-text text-danger mt-2" id="pwMsg"></div>
                                </div>
                                <div class="d-grid gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg py-3 login-btn">로그인</button>
                                </div>
                                <div class="text-danger text-center mt-3" id="msg"></div>
                            </form>
                            <ul class="login-text-menu mt-5">
                                <li><a href="/user/sign-up.html">회원가입</a></li>
                                <li><a href="/user/find-password.html">PW 찾기</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.getElementById('loginForm');

        if (loginForm) {
            loginForm.onsubmit = async function(e) {
                e.preventDefault();
                const userId = document.getElementById('userId').value;
                const password = document.getElementById('password').value;

                if (!userId || !password) {
                    Swal.fire({
                        icon: 'warning',
                        text: '아이디와 비밀번호를 모두 입력해주세요.'
                    });
                    return;
                }

                try {
                    const res = await fetch('http://localhost:13000/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId, password }),
                        credentials: 'include'
                    });
                    const data = await res.json();
                    if (res.ok && data.result === 1 && data.accessToken) {
                        document.cookie = `jwtAccessToken=${data.accessToken}; path=/; SameSite=Lax; max-age=3600;`;
                        console.log('토큰을 쿠키에 저장 완료');
                        // JWT에서 사용자 이름 추출
                        let userName = '';
                        try {
                            const decoded = jwt_decode(data.accessToken);
                            userName = decoded.userName || '';
                        } catch (e) {
                            userName = '';
                        }
                        Swal.fire({
                            icon: 'success',
                            text: `${userName ? userName + '님, ' : ''}반가워요! 메인 페이지로 이동합니다.`,
                            timer: 1500,
                            showConfirmButton: false
                        });
                        setTimeout(() => {
                            window.location.href = 'http://localhost:14000/user/index.html';
                        }, 1500);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            text: data.msg || '로그인 실패',
                            showConfirmButton: true
                        });
                    }
                } catch (err) {
                    Swal.fire({
                        icon: 'error',
                        text: '로그인 요청 실패'
                    });
                    console.error('로그인 요청 중 오류 발생:', err);
                }
            };
        } else {
            console.error("오류: 'loginForm' 요소를 찾을 수 없습니다.");
        }
    });
</script>
</body>
</html>
