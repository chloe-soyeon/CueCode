<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 대시보드</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .patient-table th, .patient-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    .patient-table th {
      font-weight: 600;
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100">
<header class="bg-indigo-600 text-white p-4 shadow-md">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-2xl font-bold">환자 관리 대시보드</h1>
    <nav>
      <a href="#" id="logout-btn" class="px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200">로그아웃</a>
    </nav>
  </div>
</header>

<main class="flex-grow container mx-auto p-4 sm:p-8">
  <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">환자 목록</h2>
    <div id="patient-list" class="overflow-x-auto">
      <table class="patient-table w-full border-collapse">
        <thead>
        <tr>
          <th class="rounded-tl-lg">환자 ID</th>
          <th>이름</th>
          <th>상태</th>
          <th class="rounded-tr-lg">최근 확인</th>
        </tr>
        </thead>
        <tbody id="patient-list-tbody">
        <!-- 환자 목록이 동적으로 여기에 로드됩니다. -->
        </tbody>
      </table>
    </div>
  </div>
</main>

<footer class="bg-gray-800 text-white text-center p-4 mt-8">
  <p>&copy; 2025 K-PaaS 프로젝트. 모든 권리 보유.</p>
</footer>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const patientListBody = document.getElementById('patient-list-tbody');
    const logoutBtn = document.getElementById('logout-btn');

    // --- 로그아웃 기능 ---
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const res = await fetch('http://localhost:13000/user/v1/logout', {
          method: 'POST'
        });
        if (res.ok) {
          alert('로그아웃되었습니다.');
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('로그아웃 실패:', error);
        alert('로그아웃 중 오류가 발생했습니다.');
      }
    });

    // --- 환자 목록 불러오기 (API 호출) ---
    const fetchPatients = async () => {
      try {
        // Authorization 헤더 없이 쿠키만 포함
        const res = await fetch('http://localhost:13000/patient/list', {
          method: 'GET',
          credentials: 'include'
        });

        if (res.status === 403) {
          alert("로그인 세션이 만료되었습니다. 다시 로그인해주세요.");
          window.location.href = '/login';
          return;
        }

        if (!res.ok) {
          throw new Error('API 호출에 실패했습니다.');
        }

        const patientData = await res.json();

        // 기존 목록 초기화
        patientListBody.innerHTML = '';

        // 받은 데이터를 화면에 렌더링
        patientData.forEach(patient => {
          const row = document.createElement('tr');
          // 임시 상태 값 설정 (실제 데이터에 따라 수정 필요)
          const status = Math.random() > 0.8 ? '응급' : (Math.random() > 0.5 ? '주의' : '정상');
          const lastCheck = new Date().toISOString().slice(0, 10); // 임시 날짜
          const statusColor = status === '정상' ? 'text-green-600' :
                  status === '주의' ? 'text-yellow-600' :
                          'text-red-600';
          row.innerHTML = `
                            <td class="whitespace-nowrap">${patient.id}</td>
                            <td class="whitespace-nowrap">${patient.name}</td>
                            <td class="font-medium ${statusColor}">${status}</td>
                            <td class="whitespace-nowrap">${lastCheck}</td>
                        `;
          patientListBody.appendChild(row);
        });
      } catch (error) {
        console.error("환자 목록 로딩 실패:", error);
        patientListBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500">환자 목록을 불러오지 못했습니다.</td></tr>`;
      }
    };

    fetchPatients();
  });
</script>
</body>
</html>
